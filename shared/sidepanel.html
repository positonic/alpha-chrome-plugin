<!DOCTYPE html>
<html>
  <head>
    <title>Voice Dictation</title>
    <style>
      /* ===== Design Tokens ===== */
      :root {
        /* Spacing Scale */
        --space-xs: 8px;
        --space-sm: 12px;
        --space-md: 16px;
        --space-lg: 24px;
        --space-xl: 32px;
        
        /* Colors - Simplified Palette */
        --color-primary: #2563eb;
        --color-primary-hover: #1d4ed8;
        --color-primary-light: #eff6ff;
        --color-success: #10b981;
        --color-success-hover: #059669;
        --color-error: #dc2626;
        --color-error-hover: #b91c1c;
        
        /* Neutrals */
        --color-gray-50: #f9fafb;
        --color-gray-100: #f3f4f6;
        --color-gray-200: #e5e7eb;
        --color-gray-300: #d1d5db;
        --color-gray-400: #9ca3af;
        --color-gray-500: #6b7280;
        --color-gray-600: #4b5563;
        --color-gray-700: #374151;
        --color-gray-900: #111827;
        
        /* Typography */
        --font-size-xs: 11px;
        --font-size-sm: 13px;
        --font-size-base: 15px;
        --font-size-lg: 16px;
        --font-size-xl: 18px;
        
        --font-weight-normal: 400;
        --font-weight-medium: 500;
        --font-weight-semibold: 600;
        --font-weight-bold: 700;
        
        /* Border Radius */
        --radius-sm: 6px;
        --radius-md: 8px;
        --radius-lg: 12px;
        
        /* Shadows */
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.08);
        --shadow-button: 0 2px 4px rgba(37, 99, 235, 0.15);
        
        /* Transitions */
        --transition-fast: 150ms ease;
        --transition-base: 200ms ease;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        padding: var(--space-md);
        background: var(--color-gray-50);
        margin: 0;
        min-height: 100vh;
        box-sizing: border-box;
      }
      button {
        margin-bottom: var(--space-sm);
        padding: var(--space-sm) var(--space-lg);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: var(--font-weight-semibold);
        font-size: var(--font-size-base);
        width: 100%;
        transition: all var(--transition-base);
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
      }
      button:active {
        transform: translateY(0);
      }
      button:disabled {
        background: var(--color-gray-200) !important;
        color: var(--color-gray-400);
        cursor: not-allowed;
        box-shadow: none !important;
        transform: none;
      }
      
      /* Primary Action - Large, prominent recording button */
      .btn-primary {
        background: var(--color-primary);
        box-shadow: var(--shadow-button);
        padding: var(--space-md) var(--space-lg);
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-bold);
        margin-bottom: var(--space-md);
      }
      .btn-primary:hover {
        background: var(--color-primary-hover);
      }
      
      /* Recording state button */
      .btn-recording {
        background: var(--color-error);
        box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
      }
      .btn-recording:hover {
        background: var(--color-error-hover);
      }
      
      /* Continue recording button */
      .btn-continue {
        background: var(--color-primary);
        box-shadow: var(--shadow-button);
      }
      .btn-continue:hover {
        background: var(--color-primary-hover);
      }
      /* Secondary button style */
      .btn-new-recording {
        font-size: var(--font-size-sm);
        padding: var(--space-xs) var(--space-md);
        background: white;
        color: var(--color-gray-700);
        border: 1.5px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        cursor: pointer;
        margin-top: var(--space-xs);
        font-weight: var(--font-weight-medium);
        box-shadow: var(--shadow-sm);
      }
      .btn-new-recording:hover {
        background: var(--color-gray-50);
        border-color: var(--color-gray-400);
        transform: none;
      }
      #output {
        white-space: pre-wrap;
        margin: 0;
        padding: var(--space-md);
        background: white;
        border-radius: var(--radius-md);
        min-height: 160px;
        flex: 1;
        line-height: 1.6;
        border: 1.5px solid var(--color-gray-200);
        font-size: var(--font-size-base);
        color: var(--color-gray-700);
        box-shadow: var(--shadow-sm);
        overflow-y: auto;
        overflow-x: hidden;
        word-wrap: break-word;
        box-sizing: border-box;
      }
      #output:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px var(--color-primary-light);
      }
      #output:empty::before {
        content: 'Start a new recording or select one to continue...';
        color: #9ca3af;
        pointer-events: none;
      }
      .status-bar {
        background: white;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-md);
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-medium);
        box-shadow: var(--shadow-sm);
        border: 1.5px solid var(--color-gray-200);
        display: flex;
        align-items: center;
        gap: var(--space-xs);
      }
      .status-bar::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--color-gray-400);
        flex-shrink: 0;
      }
      .listening {
        color: var(--color-primary);
        font-weight: var(--font-weight-semibold);
      }
      .status-bar.listening::before {
        background: var(--color-primary);
        animation: pulse 2s ease-in-out infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Panel tabs (Save Page / Recording) - Improved spacing and styling */
      .panel-tabs {
        display: none;
      }
      .panel-tabs.visible {
        display: flex;
        gap: var(--space-xs);
        margin-bottom: var(--space-lg);
        padding: 4px;
        border-radius: var(--radius-lg);
        background: var(--color-gray-100);
      }
      .panel-tabs button {
        flex: 1;
        margin: 0;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
        background: transparent;
        color: var(--color-gray-600);
        box-shadow: none;
        border: none;
        transition: all var(--transition-fast);
      }
      .panel-tabs button:hover {
        transform: none;
        background: white;
        color: var(--color-gray-900);
      }
      .panel-tabs button.active {
        background: white;
        color: var(--color-primary);
        box-shadow: var(--shadow-sm);
      }

      /* Tab content panels */
      .tab-panel {
        display: none;
      }
      .tab-panel.active {
        display: block;
      }

      /* Shared project selector - Collapsible with better spacing */
      .shared-project-selector {
        display: none;
        margin-bottom: var(--space-lg);
      }
      .shared-project-selector.visible {
        display: block;
      }
      .shared-project-selector summary {
        padding: var(--space-sm) var(--space-md);
        background: white;
        border: 1.5px solid var(--color-gray-200);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--color-gray-700);
        list-style: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-sm);
        transition: all var(--transition-fast);
      }
      .shared-project-selector summary:hover {
        border-color: var(--color-gray-300);
        background: var(--color-gray-50);
      }
      .shared-project-selector summary::after {
        content: 'â–¼';
        font-size: 10px;
        color: var(--color-gray-500);
        transition: transform var(--transition-fast);
      }
      .shared-project-selector details[open] summary::after {
        transform: rotate(180deg);
      }
      .shared-select {
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        border: 1.5px solid var(--color-gray-200);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        background: white;
        transition: border-color var(--transition-fast);
        box-sizing: border-box;
        margin-bottom: var(--space-xs);
        color: var(--color-gray-700);
      }
      .shared-select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px var(--color-primary-light);
      }

      /* Save page */
      .save-page-input {
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        border: 1.5px solid var(--color-gray-200);
        border-radius: var(--radius-md);
        font-size: var(--font-size-base);
        background: white;
        transition: border-color var(--transition-fast);
        box-sizing: border-box;
        margin-bottom: var(--space-sm);
      }
      .save-page-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px var(--color-primary-light);
      }
      .btn-save-page {
        background: var(--color-success);
        box-shadow: var(--shadow-button);
      }
      .btn-save-page:hover {
        background: var(--color-success-hover);
      }
      .save-page-status {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        min-height: 18px;
        margin-top: var(--space-xs);
      }
      .save-page-status.success { color: var(--color-success); }
      .save-page-status.error { color: var(--color-error); }

      /* Create Action */
      .create-action-desc {
        resize: vertical;
        font-family: inherit;
        line-height: 1.5;
        min-height: 80px;
      }
      .create-action-priority {
        margin-bottom: var(--space-sm);
      }
      .btn-create-action {
        background: var(--color-primary);
        box-shadow: var(--shadow-button);
      }
      .btn-create-action:hover {
        background: var(--color-primary-hover);
      }

      /* Model progress - Improved visibility */
      .model-status {
        margin-bottom: var(--space-md);
        display: none;
        padding: var(--space-md);
        background: white;
        border-radius: var(--radius-md);
        border: 1.5px solid var(--color-gray-200);
      }
      .model-status.visible {
        display: block;
      }
      .progress-bar-bg {
        background: var(--color-gray-200);
        border-radius: var(--radius-sm);
        height: 8px;
        overflow: hidden;
        margin-top: var(--space-sm);
      }
      .progress-bar-fill {
        background: var(--color-primary);
        height: 100%;
        width: 0%;
        transition: width 0.3s ease;
        border-radius: var(--radius-sm);
      }
      .model-status-text {
        font-size: var(--font-size-sm);
        color: var(--color-gray-600);
        font-weight: var(--font-weight-medium);
      }

      .output-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-sm);
        margin-top: var(--space-lg);
      }
      .output-label {
        color: var(--color-gray-600);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
        letter-spacing: 0.025em;
      }
      #session-url {
        display: none;
        color: var(--color-primary);
        text-decoration: none;
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
      }
      #session-url:hover {
        text-decoration: underline;
      }

      /* Annotation controls - Tertiary button style, better spacing */
      .annotation-controls {
        display: flex;
        gap: var(--space-sm);
        margin-bottom: var(--space-lg);
        align-items: center;
        padding: var(--space-sm);
        background: white;
        border-radius: var(--radius-md);
        border: 1.5px solid var(--color-gray-200);
      }
      .btn-draw {
        background: transparent;
        color: var(--color-gray-700);
        border: 1.5px solid var(--color-gray-300);
        box-shadow: none;
        flex-shrink: 0;
        width: auto;
        padding: var(--space-sm) var(--space-md);
        margin-bottom: 0;
        font-size: var(--font-size-sm);
      }
      .btn-draw:hover {
        background: var(--color-gray-50);
        border-color: var(--color-gray-400);
        transform: none;
      }
      .btn-draw.active {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
        box-shadow: var(--shadow-button);
      }
      .tool-toggle {
        display: none;
        gap: 4px;
        padding: 2px;
        border-radius: var(--radius-sm);
        background: var(--color-gray-100);
      }
      .tool-toggle.visible {
        display: flex;
      }
      .tool-toggle button {
        flex: 1;
        margin: 0;
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
        background: transparent;
        color: var(--color-gray-600);
        box-shadow: none;
        border: none;
        width: auto;
      }
      .tool-toggle button:hover {
        transform: none;
        background: white;
        color: var(--color-gray-900);
      }
      .tool-toggle button.active {
        background: white;
        color: var(--color-primary);
        box-shadow: var(--shadow-sm);
      }
      .btn-clear {
        background: var(--color-gray-500) !important;
        color: white !important;
        flex-shrink: 0;
        width: auto;
        padding: var(--space-sm) var(--space-md);
        margin-bottom: 0;
        font-size: var(--font-size-sm);
        border: none;
      }
      .btn-clear:hover {
        background: var(--color-gray-600) !important;
      }

      /* Setup section - Cleaner, more spacious */
      .setup-card {
        background: white;
        padding: var(--space-lg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1.5px solid var(--color-gray-200);
        margin-bottom: var(--space-lg);
      }
      .setup-card h2 {
        margin: 0 0 var(--space-md) 0;
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-gray-900);
      }
      .setup-input {
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        border: 1.5px solid var(--color-gray-200);
        border-radius: var(--radius-md);
        font-size: var(--font-size-base);
        background: white;
        transition: border-color var(--transition-fast);
        box-sizing: border-box;
        margin-bottom: var(--space-sm);
      }
      .setup-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px var(--color-primary-light);
      }
      .setup-select {
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        border: 1.5px solid var(--color-gray-200);
        border-radius: var(--radius-md);
        font-size: var(--font-size-base);
        background: white;
        transition: border-color var(--transition-fast);
        box-sizing: border-box;
        margin-bottom: var(--space-sm);
      }
      .setup-select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px var(--color-primary-light);
      }
      .setup-status {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--color-success);
        min-height: 18px;
      }
      .setup-status.error {
        color: var(--color-error);
      }
      .hidden {
        display: none !important;
      }

      /* Settings header bar - Cleaner, more polished */
      .settings-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-lg);
        padding-bottom: var(--space-md);
        border-bottom: 1px solid var(--color-gray-200);
      }
      .settings-bar .app-name {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-bold);
        color: var(--color-gray-900);
      }
      .test-mode-badge {
        font-size: var(--font-size-xs);
        color: #d97706;
        font-weight: var(--font-weight-semibold);
        margin-left: var(--space-sm);
        padding: 2px var(--space-xs);
        background: #fef3c7;
        border-radius: var(--radius-sm);
      }
      .btn-settings {
        background: white;
        color: var(--color-gray-600);
        border: 1.5px solid var(--color-gray-200);
        border-radius: var(--radius-md);
        cursor: pointer;
        padding: var(--space-xs) var(--space-md);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        width: auto;
        margin: 0;
        transition: all var(--transition-fast);
        box-shadow: none;
      }
      .btn-settings:hover {
        background: var(--color-gray-50);
        border-color: var(--color-gray-300);
        color: var(--color-gray-900);
        transform: none;
      }

      /* Settings dropdown */
      .settings-dropdown {
        background: white;
        border: 1.5px solid var(--color-gray-200);
        border-radius: var(--radius-lg);
        padding: var(--space-md);
        margin-bottom: var(--space-lg);
        box-shadow: var(--shadow-lg);
      }
      .settings-dropdown .btn-danger {
        background: white;
        color: var(--color-error);
        border: 1.5px solid #fecaca;
        font-size: var(--font-size-sm);
        padding: var(--space-sm) var(--space-md);
      }
      .settings-dropdown .btn-danger:hover {
        background: #fef2f2;
        border-color: var(--color-error);
        transform: none;
      }

      /* Recording history list - More spacious and prominent */
      .recording-history {
        margin-top: var(--space-xl);
        padding-top: var(--space-lg);
        border-top: 1px solid var(--color-gray-200);
      }
      .recording-history-header {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
        color: var(--color-gray-600);
        margin-bottom: var(--space-sm);
        text-transform: uppercase;
        letter-spacing: 0.025em;
      }
      .recording-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
        max-height: 320px;
        overflow-y: auto;
      }
      .recording-item {
        padding: var(--space-sm) var(--space-md);
        background: white;
        border: 1.5px solid var(--color-gray-200);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all var(--transition-fast);
      }
      .recording-item:hover {
        border-color: var(--color-gray-300);
        background: var(--color-gray-50);
        box-shadow: var(--shadow-sm);
      }
      .recording-item.selected {
        border-color: var(--color-primary);
        background: var(--color-primary-light);
        border-left-width: 3px;
      }
      .recording-item-title {
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-semibold);
        color: var(--color-gray-900);
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .recording-item-preview {
        font-size: var(--font-size-sm);
        color: var(--color-gray-500);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.4;
      }
      .recording-item-time {
        font-size: var(--font-size-xs);
        color: var(--color-gray-400);
        margin-top: 4px;
      }
      /* Recording item expand arrow */
      .recording-item-header {
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }
      .recording-item-header-content {
        flex: 1;
        min-width: 0;
      }
      .recording-item-arrow {
        font-size: 10px;
        color: #9ca3af;
        transition: transform 0.2s ease;
        margin-top: 3px;
        flex-shrink: 0;
      }
      .recording-item.expanded .recording-item-arrow {
        transform: rotate(90deg);
      }
      /* Actions drawer below recording item */
      .recording-actions-drawer {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.25s ease;
      }
      .recording-actions-drawer.open {
        max-height: 500px;
      }
      .recording-actions-list {
        padding: 8px 0 4px 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .recording-action-link {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
        padding: var(--space-xs) var(--space-sm);
        background: var(--color-gray-50);
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-sm);
        text-decoration: none;
        color: var(--color-gray-700);
        font-size: var(--font-size-sm);
        transition: all var(--transition-fast);
        cursor: pointer;
      }
      .recording-action-link:hover {
        background: var(--color-primary-light);
        border-color: var(--color-primary);
        color: var(--color-primary);
      }
      .recording-action-link-icon {
        flex-shrink: 0;
        width: 14px;
        height: 14px;
        color: var(--color-gray-400);
      }
      .recording-action-link:hover .recording-action-link-icon {
        color: var(--color-primary);
      }
      .recording-action-link-name {
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .recording-action-link-priority {
        font-size: 10px;
        padding: 1px 6px;
        border-radius: 4px;
        font-weight: 500;
        flex-shrink: 0;
      }
      .priority-1st-priority { background: #fef2f2; color: #dc2626; }
      .priority-2nd-priority { background: #fff7ed; color: #ea580c; }
      .priority-3rd-priority { background: #fffbeb; color: #d97706; }
      .priority-4th-priority { background: #f0fdf4; color: #16a34a; }
      .priority-5th-priority { background: #f0fdf4; color: #6b7280; }
      .priority-quick { background: #eff6ff; color: #2563eb; }
      .priority-scheduled { background: #faf5ff; color: #7c3aed; }
      .priority-errand { background: #f5f5f4; color: #78716c; }
      .priority-remember { background: #fdf4ff; color: #a21caf; }
      .priority-watch { background: #ecfeff; color: #0891b2; }
      .priority-someday-maybe { background: #f8fafc; color: #94a3b8; }
      .recording-actions-empty {
        font-size: 11px;
        color: #9ca3af;
        padding: 6px 10px;
        text-align: center;
      }
      .recording-actions-loading {
        font-size: 11px;
        color: #9ca3af;
        padding: 6px 10px;
        text-align: center;
      }
      .recording-add-action-btn {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
        padding: var(--space-xs) var(--space-sm);
        background: transparent;
        border: 1px dashed var(--color-gray-300);
        border-radius: var(--radius-sm);
        color: var(--color-gray-500);
        font-size: var(--font-size-sm);
        cursor: pointer;
        transition: all var(--transition-fast);
        width: 100%;
        margin: 0;
        box-shadow: none;
        font-weight: var(--font-weight-medium);
      }
      .recording-add-action-btn:hover {
        background: var(--color-gray-50);
        border-color: var(--color-gray-400);
        color: var(--color-gray-700);
        transform: none;
      }
      .recording-add-action-form {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .recording-add-action-input {
        flex: 1;
        padding: var(--space-xs) var(--space-sm);
        border: 1.5px solid var(--color-gray-200);
        border-radius: var(--radius-sm);
        font-size: var(--font-size-sm);
        font-family: inherit;
        background: white;
        color: var(--color-gray-700);
        outline: none;
        transition: border-color var(--transition-fast);
        min-width: 0;
      }
      .recording-add-action-input:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px var(--color-primary-light);
      }
      .recording-add-action-input::placeholder {
        color: var(--color-gray-400);
      }
      .recording-add-action-submit {
        padding: var(--space-xs) var(--space-sm);
        background: var(--color-primary);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
        cursor: pointer;
        flex-shrink: 0;
        width: auto;
        margin: 0;
        box-shadow: none;
        transition: all var(--transition-fast);
      }
      .recording-add-action-submit:hover {
        background: var(--color-primary-hover);
        transform: none;
      }
      .recording-add-action-submit:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Generate Actions button - Secondary action style */
      .btn-generate-actions {
        background: var(--color-primary);
        box-shadow: var(--shadow-button);
        margin-top: var(--space-lg);
        font-weight: var(--font-weight-semibold);
      }
      .btn-generate-actions:hover {
        background: var(--color-primary-hover);
      }
      .btn-generate-actions.loading {
        opacity: 0.7;
        cursor: wait;
      }

      /* Actions modal overlay - Improved backdrop and card */
      .actions-modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding: var(--space-lg) var(--space-md);
        overflow-y: auto;
      }
      .actions-modal-overlay.hidden { display: none !important; }
      .actions-modal-card {
        background: white;
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 480px;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 48px);
      }
      .actions-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-lg) var(--space-lg) var(--space-md);
        border-bottom: 1px solid var(--color-gray-200);
      }
      .actions-modal-header h3 {
        margin: 0;
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-gray-900);
      }
      .actions-modal-close-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--color-gray-400);
        cursor: pointer;
        padding: 0 var(--space-xs);
        width: auto;
        margin: 0;
        box-shadow: none;
        line-height: 1;
      }
      .actions-modal-close-btn:hover {
        color: var(--color-gray-700);
        transform: none;
      }
      .actions-modal-body {
        overflow-y: auto;
        padding: var(--space-sm) 0;
        flex: 1;
        min-height: 0;
      }
      .actions-modal-footer {
        padding: var(--space-md) var(--space-lg);
        border-top: 1px solid var(--color-gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--color-gray-50);
      }
      .actions-modal-select-all {
        font-size: var(--font-size-sm);
        color: var(--color-gray-600);
      }
      .actions-modal-select-all label {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
        cursor: pointer;
        font-weight: var(--font-weight-medium);
      }
      .actions-modal-buttons {
        display: flex;
        gap: var(--space-sm);
      }
      .btn-modal-cancel {
        background: white;
        color: var(--color-gray-700);
        border: 1.5px solid var(--color-gray-300);
        font-size: var(--font-size-base);
        padding: var(--space-sm) var(--space-lg);
        width: auto;
        margin: 0;
        box-shadow: none;
        font-weight: var(--font-weight-medium);
      }
      .btn-modal-cancel:hover {
        background: var(--color-gray-50);
        border-color: var(--color-gray-400);
        transform: none;
      }
      .btn-modal-publish {
        background: var(--color-success);
        box-shadow: var(--shadow-button);
        font-size: var(--font-size-base);
        padding: var(--space-sm) var(--space-lg);
        width: auto;
        margin: 0;
        font-weight: var(--font-weight-semibold);
      }
      .btn-modal-publish:hover {
        background: var(--color-success-hover);
      }
      .btn-modal-publish:disabled {
        background: var(--color-gray-200) !important;
        color: var(--color-gray-400);
        box-shadow: none !important;
      }

      /* Action row in modal - Better spacing */
      .action-row {
        display: flex;
        align-items: flex-start;
        gap: var(--space-sm);
        padding: var(--space-md) var(--space-lg);
        border-bottom: 1px solid var(--color-gray-100);
      }
      .action-row:last-child { border-bottom: none; }
      .action-row:hover { background: var(--color-gray-50); }
      .action-row input[type="checkbox"] {
        margin-top: 3px;
        flex-shrink: 0;
      }
      .action-row-content {
        flex: 1;
        min-width: 0;
      }
      .action-edit-name {
        width: 100%;
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-semibold);
        color: var(--color-gray-900);
        border: none;
        border-bottom: 1.5px solid transparent;
        background: transparent;
        padding: 4px 0;
        margin-bottom: var(--space-xs);
        outline: none;
        font-family: inherit;
        box-sizing: border-box;
      }
      .action-edit-name:focus {
        border-bottom-color: var(--color-primary);
      }
      .action-edit-desc {
        width: 100%;
        font-size: var(--font-size-sm);
        color: var(--color-gray-600);
        border: none;
        border-bottom: 1.5px solid transparent;
        background: transparent;
        padding: 4px 0;
        outline: none;
        font-family: inherit;
        resize: none;
        line-height: 1.5;
        box-sizing: border-box;
        overflow: hidden;
      }
      .action-edit-desc:focus {
        border-bottom-color: var(--color-primary);
      }
      .action-screenshots {
        display: flex;
        gap: 6px;
        margin-top: 6px;
        flex-wrap: wrap;
      }
      .action-screenshot-thumb {
        width: 60px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #e5e7eb;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .action-screenshot-thumb:hover {
        border-color: #2D68E5;
        box-shadow: 0 2px 8px rgba(45, 104, 229, 0.2);
        transform: scale(1.05);
      }
      .recording-action-screenshot-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        font-size: 9px;
        font-weight: 600;
        background: #dbeafe;
        color: #2563eb;
        border-radius: 50%;
        flex-shrink: 0;
        margin-left: 4px;
      }
      .action-edit-priority {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 4px;
        border-radius: 4px;
        flex-shrink: 0;
        text-transform: uppercase;
        border: none;
        cursor: pointer;
        outline: none;
        appearance: none;
        -webkit-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5' viewBox='0 0 8 5'%3E%3Cpath d='M0 0l4 5 4-5z' fill='%239ca3af'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 4px center;
        padding-right: 14px;
      }
      .action-edit-priority:focus {
        box-shadow: 0 0 0 2px rgba(45, 104, 229, 0.2);
      }
      .action-edit-priority.priority-1st-priority { background-color: #fef2f2; color: #dc2626; }
      .action-edit-priority.priority-2nd-priority { background-color: #fff7ed; color: #ea580c; }
      .action-edit-priority.priority-3rd-priority { background-color: #fefce8; color: #ca8a04; }
      .action-edit-priority.priority-4th-priority { background-color: #f0fdf4; color: #16a34a; }
      .action-edit-priority.priority-5th-priority { background-color: #f0fdf4; color: #6b7280; }
      .action-edit-priority.priority-quick { background-color: #eff6ff; color: #2563eb; }
      .action-edit-priority.priority-scheduled { background-color: #faf5ff; color: #7c3aed; }
      .action-edit-priority.priority-errand { background-color: #f5f5f4; color: #78716c; }
      .action-edit-priority.priority-remember { background-color: #fdf4ff; color: #a21caf; }
      .action-edit-priority.priority-watch { background-color: #ecfeff; color: #0891b2; }
      .action-edit-priority.priority-someday-maybe { background-color: #f8fafc; color: #94a3b8; }
      .actions-modal-loading,
      .actions-modal-empty {
        text-align: center;
        padding: var(--space-xl) var(--space-lg);
        color: var(--color-gray-600);
        font-size: var(--font-size-base);
      }
      .actions-modal-error {
        text-align: center;
        padding: var(--space-lg) var(--space-lg);
        color: var(--color-error);
        font-size: var(--font-size-sm);
      }
    </style>
  </head>
  <body>
    <!-- Settings bar (visible after setup) -->
    <div class="settings-bar hidden" id="settingsBar">
      <span class="app-name">
        <span id="appName"></span>
        <span class="test-mode-badge hidden" id="testModeBadge"></span>
      </span>
      <button class="btn-settings" id="settingsBtn">Settings</button>
    </div>

    <!-- Settings dropdown (toggled by settings button) -->
    <div class="settings-dropdown hidden" id="settingsDropdown">
      <div style="margin-bottom: 8px; font-size: 12px; color: #6b7280;" id="currentKeyDisplay"></div>
      <div style="display: flex; gap: 8px;">
        <button class="btn-danger" id="clearApiKeyBtn">Disconnect</button>
      </div>
    </div>

    <!-- Setup section (visible until configured) -->
    <div id="setupSection">
      <div class="setup-card hidden" id="autoAuthCard" style="text-align:center;">
        <p style="margin:0;font-size:14px;color:#6b7280;">Connecting to your account...</p>
      </div>
      <div class="setup-card" id="apiKeyCard">
        <h2>API Key Required</h2>
        <a href="https://exponential.im/settings/api-keys" target="_blank" style="display:inline-block;margin-bottom:10px;font-size:13px;color:#2D68E5;font-weight:500;">Get your API key</a>
        <input type="text" id="apiKeyInput" class="setup-input" placeholder="Enter your API key">
        <button class="btn-primary" id="saveApiKeyBtn">Save API Key</button>
        <div class="setup-status" id="apiKeyStatus"></div>
      </div>
      <div class="setup-card hidden" id="projectCard">
        <h2>Select Workspace & Project</h2>
        <select id="setupWorkspaceDropdown" class="setup-select">
          <option value="">Select a workspace...</option>
        </select>
        <select id="projectDropdown" class="setup-select">
          <option value="">Select a project...</option>
        </select>
        <div class="setup-status" id="projectStatus"></div>
      </div>
    </div>

    <!-- Dictation UI (hidden until setup complete) -->
    <div id="dictationUI" class="hidden">

    <!-- Shared workspace/project selector (above tabs) - Collapsible for progressive disclosure -->
    <details class="shared-project-selector" id="sharedProjectSelector">
      <summary>Workspace & Project</summary>
      <div style="padding-top: 8px;">
        <select class="shared-select" id="sharedWorkspace">
          <option value="">Select workspace...</option>
        </select>
        <select class="shared-select" id="sharedProject">
          <option value="">Select project...</option>
        </select>
      </div>
    </details>

    <!-- Panel-level tabs (conditionally shown by JS based on hasSavePage config) -->
    <div class="panel-tabs" id="panelTabs">
      <button id="tabSavePage" class="active">Save Page</button>
      <button id="tabCreateAction">Create Action</button>
      <button id="tabRecording">Recording</button>
    </div>

    <!-- Tab 1: Save Page -->
    <div class="tab-panel active" id="panelSavePage">
      <input type="text" class="save-page-input" id="savePageContext" placeholder="Add context (optional)...">
      <button class="btn-save-page" id="savePageBtn">Save Page</button>
      <div class="save-page-status" id="savePageStatus"></div>
    </div>

    <!-- Tab 2: Create Action -->
    <div class="tab-panel" id="panelCreateAction">
      <input type="text" class="save-page-input" id="createActionName" placeholder="Action name...">
      <textarea class="save-page-input create-action-desc" id="createActionDesc" placeholder="Description (optional)..." rows="3"></textarea>
      <select class="shared-select create-action-priority" id="createActionPriority">
        <option value="Quick" selected>Quick</option>
        <option value="Scheduled">Scheduled</option>
        <option value="1st Priority">1st Priority</option>
        <option value="2nd Priority">2nd Priority</option>
        <option value="3rd Priority">3rd Priority</option>
        <option value="4th Priority">4th Priority</option>
        <option value="5th Priority">5th Priority</option>
        <option value="Errand">Errand</option>
        <option value="Remember">Remember</option>
        <option value="Watch">Watch</option>
        <option value="Someday Maybe">Someday Maybe</option>
      </select>
      <button class="btn-create-action" id="createActionBtn">Create Action</button>
      <div class="save-page-status" id="createActionStatus"></div>
    </div>

    <!-- Tab 3: Recording (contains all existing dictation UI) -->
    <div class="tab-panel" id="panelRecording">

    <input type="text" class="save-page-input" id="recordingName" placeholder="Recording name (optional)...">

    <!-- Model download progress -->
    <div class="model-status" id="modelStatus">
      <span class="model-status-text" id="modelStatusText">Loading model...</span>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="modelProgressBar"></div>
      </div>
    </div>

    <div class="status-bar">Status: <span id="status">Ready</span></div>
    <button id="toggleDictation" class="btn-primary">Start Recording</button>
    <button id="newRecordingBtn" class="btn-new-recording" style="display:none;">+ New Recording</button>

    <!-- Annotation controls -->
    <div class="annotation-controls">
      <button id="toggleDraw" class="btn-draw" title="Toggle drawing mode (Ctrl+Shift+D)">Draw</button>
      <div class="tool-toggle" id="toolToggle">
        <button id="toolArrow" class="active" title="Arrow tool">Arrow</button>
        <button id="toolFreehand" title="Freehand tool">Freehand</button>
      </div>
      <button id="clearAnnotations" class="btn-clear" title="Clear all annotations" style="display:none;">Clear</button>
      <button id="screenshotBtn" class="btn-clear" title="Take a screenshot" style="margin-left: auto;">Screenshot</button>
    </div>

    <div class="output-header">
      <span class="output-label">Transcribed text:</span>
      <a id="session-url" href="#" target="_blank">View recording</a>
    </div>
    <div id="output" contenteditable="true" spellcheck="false"></div>

    <button id="generateActionsBtn" class="btn-generate-actions hidden">Generate Actions</button>

    <!-- Recording history -->
    <div class="recording-history" id="recordingHistory">
      <div class="recording-history-header">Recent Recordings</div>
      <div class="recording-list" id="recordingList"></div>
    </div>

    </div><!-- end #panelRecording -->

    </div><!-- end #dictationUI -->

    <!-- Generate Actions review modal -->
    <div id="actionsModal" class="actions-modal-overlay hidden">
      <div class="actions-modal-card">
        <div class="actions-modal-header">
          <h3>Review Actions</h3>
          <button id="actionsModalClose" class="actions-modal-close-btn">&times;</button>
        </div>
        <div class="actions-modal-body" id="actionsModalBody"></div>
        <div class="actions-modal-footer">
          <div class="actions-modal-select-all">
            <label><input type="checkbox" id="actionsSelectAll" checked> Select all</label>
          </div>
          <div class="actions-modal-buttons">
            <button id="actionsModalCancel" class="btn-modal-cancel">Cancel</button>
            <button id="actionsModalPublish" class="btn-modal-publish">Create Actions</button>
          </div>
        </div>
      </div>
    </div>

    <script src="config.js"></script>
    <script src="speech-engine-whisper.js"></script>
    <script src="sidepanel.js"></script>
  </body>
</html>
